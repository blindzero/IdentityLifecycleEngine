name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Artifact release tag name (e.g. v0.7.0-test). This does NOT need to exist as a git tag.'
        required: false
        type: string
      publish_release:
        description: 'If true, create a GitHub Release and upload the ZIP as a release asset.'
        required: false
        default: false
        type: boolean
      publish_psgallery:
        description: 'If true, publish the module to PowerShell Gallery (requires explicit intent).'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  release:
    name: Build artifact (and optionally publish release)
    runs-on: ubuntu-latest

    outputs:
      tag: ${{ steps.tag.outputs.value }}
      is_prerelease: ${{ steps.semver.outputs.is_prerelease }}
      is_stable: ${{ steps.semver.outputs.is_stable }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          # Always checkout the workflow ref (branch/tag selected in the UI or the pushed tag ref).
          # Never treat the "tag" input as a git ref.
          ref: ${{ github.ref }}

      - name: Show PowerShell version
        shell: pwsh
        run: |
          $PSVersionTable.PSVersion
          pwsh -v

      - name: Determine artifact tag
        id: tag
        shell: pwsh
        run: |
          $inputTag = '${{ inputs.tag }}'
          if (-not [string]::IsNullOrWhiteSpace($inputTag)) {
            "value=$inputTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 0
          }

          $refName = '${{ github.ref_name }}'
          if ([string]::IsNullOrWhiteSpace($refName)) {
            throw "github.ref_name is empty. Provide inputs.tag when using workflow_dispatch."
          }

          "value=$refName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Classify tag (stable vs prerelease)
        id: semver
        shell: pwsh
        run: |
          $tag = '${{ steps.tag.outputs.value }}'
          # Stable tags: vMAJOR.MINOR.PATCH (e.g. v0.7.0)
          $isStable = $tag -match '^v\d+\.\d+\.\d+$'
          # Pre-release tags: vMAJOR.MINOR.PATCH-<label> (e.g. v0.7.0-preview.1)
          $isPrerelease = $tag -match '^v\d+\.\d+\.\d+-[0-9A-Za-z][0-9A-Za-z\.\-]*$'

          "is_stable=$($isStable.ToString().ToLowerInvariant())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
          "is_prerelease=$($isPrerelease.ToString().ToLowerInvariant())" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Build release artifact
        shell: pwsh
        run: |
          $tag = '${{ steps.tag.outputs.value }}'
          ./tools/New-IdleReleaseArtifact.ps1 -Tag $tag

      - name: Verify artifact exists
        shell: pwsh
        run: |
          $tag = '${{ steps.tag.outputs.value }}'
          $path = "artifacts/IdLE-$tag.zip"
          if (-not (Test-Path -LiteralPath $path)) {
            throw "Expected artifact not found: $path"
          }
          Get-Item -LiteralPath $path | Format-List FullName, Length, LastWriteTimeUtc

      # For manual dry-runs we upload expanded contents (folder) to avoid a ZIP-in-ZIP experience.
      # For tag-triggered runs (or manual publish_release=true) we also upload the ZIP itself.
      - name: Expand artifact for dry-run upload
        if: ${{ inputs.publish_release != true && !startsWith(github.ref, 'refs/tags/v') }}
        shell: pwsh
        run: |
          $tag = '${{ steps.tag.outputs.value }}'
          $zipPath = "artifacts/IdLE-$tag.zip"
          $staging = "artifacts/staging-$tag"

          if (Test-Path -LiteralPath $staging) {
            Remove-Item -LiteralPath $staging -Recurse -Force
          }

          New-Item -ItemType Directory -Path $staging -Force | Out-Null
          Expand-Archive -Path $zipPath -DestinationPath $staging -Force
          Get-ChildItem -LiteralPath $staging -Recurse | Select-Object FullName | Format-List

      - name: Upload workflow artifact (expanded folder)
        if: ${{ inputs.publish_release != true && !startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/upload-artifact@v6
        with:
          name: IdLE-${{ steps.tag.outputs.value }}-expanded
          path: artifacts/staging-${{ steps.tag.outputs.value }}
          if-no-files-found: error

      - name: Upload workflow artifact (zip)
        if: ${{ inputs.publish_release == true || startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/upload-artifact@v6
        with:
          name: IdLE-${{ steps.tag.outputs.value }}-zip
          path: artifacts/IdLE-${{ steps.tag.outputs.value }}.zip
          if-no-files-found: error

      - name: Create GitHub Release (optional)
        if: ${{ inputs.publish_release == true || startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.value }}
          name: ${{ steps.tag.outputs.value }}
          generate_release_notes: true
          prerelease: ${{ steps.semver.outputs.is_prerelease == 'true' }}
          files: |
            artifacts/IdLE-${{ steps.tag.outputs.value }}.zip

  psgallery_local_test:
    name: Test module publish (local repository)
    runs-on: ubuntu-latest
    needs: release

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Show PowerShell version
        shell: pwsh
        run: |
          $PSVersionTable.PSVersion
          pwsh -v

      - name: Install PowerShellGet
        shell: pwsh
        run: |
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          Install-Module -Name PowerShellGet -Scope CurrentUser -Force -AllowClobber
          Import-Module PowerShellGet -Force
          Get-Module PowerShellGet | Select-Object Name, Version, Path | Format-List

      - name: Build publishable module package
        shell: pwsh
        run: |
          ./tools/New-IdleModulePackage.ps1 -Clean | Format-List FullName

      - name: Publish module to local PSRepository and verify install/import
        shell: pwsh
        run: |
          $modulePath = Join-Path $env:GITHUB_WORKSPACE 'artifacts/IdLE'
          if (-not (Test-Path -LiteralPath $modulePath)) {
            throw "Staged module path not found: $modulePath"
          }

          $repoPath = Join-Path $env:RUNNER_TEMP 'psrepo'
          New-Item -ItemType Directory -Path $repoPath -Force | Out-Null

          Register-PSRepository -Name 'LocalRepo' -SourceLocation $repoPath -PublishLocation $repoPath -InstallationPolicy Trusted

          Publish-Module -Path $modulePath -Repository 'LocalRepo' -ErrorAction Stop

          $published = Find-Module -Name 'IdLE' -Repository 'LocalRepo' -ErrorAction Stop
          Write-Host "Published to LocalRepo: $($published.Name) $($published.Version)"

          # Ensure we can install and import the module from the local repository.
          Install-Module -Name 'IdLE' -Repository 'LocalRepo' -Scope CurrentUser -Force -AllowClobber -ErrorAction Stop
          Import-Module IdLE -Force -ErrorAction Stop

          $m = Get-Module IdLE
          if (-not $m) { throw 'IdLE did not import successfully.' }
          Write-Host "Imported IdLE: $($m.Name) $($m.Version)"

          Unregister-PSRepository -Name 'LocalRepo' -ErrorAction SilentlyContinue

  psgallery:
    name: Publish to PowerShell Gallery
    runs-on: ubuntu-latest
    needs: [release, psgallery_local_test]
    environment: psgallery-prod

    # Safety:
    # - Publish only for stable tags (vMAJOR.MINOR.PATCH).
    # - Allow manual publish only when explicitly requested via workflow_dispatch + publish_psgallery=true.
    # - Pre-release tags are GitHub-only (no PSGallery publish).
    if: >-
      ${{
        needs.release.outputs.is_stable == 'true'
        && (
          startsWith(github.ref, 'refs/tags/v')
          || (github.event_name == 'workflow_dispatch' && inputs.publish_psgallery == true && inputs.tag != '')
        )
      }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.ref }}

      - name: Show PowerShell version
        shell: pwsh
        run: |
          $PSVersionTable.PSVersion
          pwsh -v

      - name: Install PowerShellGet
        shell: pwsh
        run: |
          Set-PSRepository -Name 'PSGallery' -InstallationPolicy Trusted
          Install-Module -Name PowerShellGet -Scope CurrentUser -Force -AllowClobber
          Import-Module PowerShellGet -Force
          Get-Module PowerShellGet | Select-Object Name, Version, Path | Format-List

      - name: Build publishable module package
        shell: pwsh
        run: |
          ./tools/New-IdleModulePackage.ps1 -Clean | Format-List FullName

      - name: Publish module to PSGallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if ([string]::IsNullOrWhiteSpace($env:PSGALLERY_API_KEY)) {
            throw "Missing secret PSGALLERY_API_KEY."
          }

          $modulePath = Join-Path $env:GITHUB_WORKSPACE 'artifacts/IdLE'
          if (-not (Test-Path -LiteralPath $modulePath)) {
            throw "Staged module path not found: $modulePath"
          }

          $manifest = Join-Path $modulePath 'IdLE.psd1'
          if (-not (Test-Path -LiteralPath $manifest)) {
            throw "Staged module manifest not found: $manifest"
          }

          $data = Import-PowerShellDataFile -LiteralPath $manifest
          Write-Host "Publishing IdLE Version: $($data.ModuleVersion)"

          Publish-Module -Path $modulePath -NuGetApiKey $env:PSGALLERY_API_KEY -Repository PSGallery -ErrorAction Stop
