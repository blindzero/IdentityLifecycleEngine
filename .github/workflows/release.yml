name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      tag:
        description: 'Artifact tag name (e.g. v0.7.0-test). This does NOT need to exist as a git tag.'
        required: false
        type: string
      publish_release:
        description: 'If true, create a GitHub Release and upload the ZIP as a release asset.'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  release:
    name: Build artifact (and optionally publish release)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Always checkout the workflow ref (branch/tag selected in the UI or the pushed tag ref).
          # Never treat the "tag" input as a git ref.
          ref: ${{ github.ref }}

      - name: Show PowerShell version
        shell: pwsh
        run: |
          $PSVersionTable.PSVersion
          pwsh -v

      - name: Determine artifact tag
        id: tag
        shell: pwsh
        run: |
          $inputTag = '${{ inputs.tag }}'
          if (-not [string]::IsNullOrWhiteSpace($inputTag)) {
            "value=$inputTag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8
            exit 0
          }

          $refName = '${{ github.ref_name }}'
          if ([string]::IsNullOrWhiteSpace($refName)) {
            throw "github.ref_name is empty. Provide inputs.tag when using workflow_dispatch."
          }

          "value=$refName" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Build release artifact
        shell: pwsh
        run: |
          $tag = '${{ steps.tag.outputs.value }}'
          ./tools/New-IdleReleaseArtifact.ps1 -Tag $tag

      - name: Verify artifact exists
        shell: pwsh
        run: |
          $tag = '${{ steps.tag.outputs.value }}'
          $path = "artifacts/IdLE-$tag.zip"
          if (-not (Test-Path -LiteralPath $path)) {
            throw "Expected artifact not found: $path"
          }
          Get-Item -LiteralPath $path | Format-List FullName, Length, LastWriteTimeUtc

      # For manual dry-runs we upload expanded contents (folder) to avoid a ZIP-in-ZIP experience.
      # For tag-triggered runs (or manual publish_release=true) we also upload the ZIP itself.
      - name: Expand artifact for dry-run upload
        if: ${{ inputs.publish_release != true && !startsWith(github.ref, 'refs/tags/v') }}
        shell: pwsh
        run: |
          $tag = '${{ steps.tag.outputs.value }}'
          $zipPath = "artifacts/IdLE-$tag.zip"
          $staging = "artifacts/staging-$tag"

          if (Test-Path -LiteralPath $staging) {
            Remove-Item -LiteralPath $staging -Recurse -Force
          }

          New-Item -Path $staging -ItemType Directory -Force | Out-Null
          Expand-Archive -LiteralPath $zipPath -DestinationPath $staging -Force

      - name: Upload workflow artifact (dry run - expanded)
        if: ${{ inputs.publish_release != true && !startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/upload-artifact@v4
        with:
          name: IdLE-${{ steps.tag.outputs.value }}
          path: artifacts/staging-${{ steps.tag.outputs.value }}/
          if-no-files-found: error

      - name: Upload workflow artifact (zip)
        if: ${{ inputs.publish_release == true || startsWith(github.ref, 'refs/tags/v') }}
        uses: actions/upload-artifact@v4
        with:
          name: IdLE-${{ steps.tag.outputs.value }}-zip
          path: artifacts/IdLE-${{ steps.tag.outputs.value }}.zip
          if-no-files-found: error

      - name: Create GitHub Release (optional)
        if: ${{ inputs.publish_release == true || startsWith(github.ref, 'refs/tags/v') }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.value }}
          name: ${{ steps.tag.outputs.value }}
          generate_release_notes: true
          files: |
            artifacts/IdLE-${{ steps.tag.outputs.value }}.zip
